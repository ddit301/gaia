<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="best.gaia.issue.dao.IssueDao">
	
	<resultMap type="best.gaia.vo.IssueVO" id="issueMap" autoMapping="true">
		<id property="issue_sid" column="ISSUE_SID"/>
		<collection property="assigneeList" ofType="MemberVO" javaType="java.util.Set" autoMapping="true">
			<id property="mem_no" column="MEM_NO"/>
		</collection>
		<collection property="historyList" ofType="IssueHistoryVO" javaType="java.util.List" autoMapping="true">
			<id property="issue_his_no" column="ISSUE_HIS_NO"/>
		</collection>
	</resultMap>
	
	<select id="selectIssue" parameterType="best.gaia.vo.IssueVO" resultMap="issueMap">
select a.issue_sid, a.issue_no, a.label_no, label.label_nm
        ,d.mem_no as writer_no, dm.proj_user_nick as writer_nick, d.mem_pic_file_name as writer_pic
        ,a.milest_sid, a.proj_no, a.issue_title
        ,a.issue_create_date, a.issue_start_date, a.issue_end_date
        ,a.issue_status, a.priority, a.progress
        ,c.mem_no, c.mem_id, cm.proj_user_nick as mem_nick, c.mem_pic_file_name
        ,e.issue_his_no, e.issue_sid 
        ,f.mem_no as his_writer_no
        ,fm.proj_user_nick as his_writer_nick, f.mem_pic_file_name as his_writer_pic
        , e.issue_his_cont, e.issue_his_date, e.issue_his_type, e.atch_file_no
        ,g.milest_title
from issue a
    left outer join issue_assignee b on (a.issue_sid = b.issue_sid)
    left outer join member c on (b.mem_no = c.mem_no)
    left outer join proj_mem cm on (a.proj_no = cm.proj_no and c.mem_no = cm.mem_no)
    left outer join member d on (a.mem_no = d.mem_no)
    left outer join proj_mem dm on (a.proj_no = dm.proj_no and d.mem_no = dm.mem_no)
    left outer join issue_history e on (a.issue_sid = e.issue_sid)
    left outer join member f on (e.mem_no = f.mem_no)
    left outer join proj_mem fm on (a.proj_no = fm.proj_no and f.mem_no = fm.mem_no)
    left outer join milestone g on (a.milest_sid = g.milest_sid)
    left outer join label on (a.proj_no = label.proj_no and a.label_no = label.label_no)
		WHERE a.PROJ_NO = #{proj_no}
			AND a.ISSUE_NO = #{issue_no}
	</select>
	
	<select id="selectIssueList" parameterType="best.gaia.vo.PagingVO" resultType="best.gaia.vo.IssueVO">
		SELECT *
		FROM ISSUE
	</select>
	
	
	<select id="selectMilestoneList" parameterType="best.gaia.vo.PagingVO" resultType="best.gaia.vo.MilestoneVO">
		SELECT A.MILEST_TITLE, TO_CHAR(A.MILEST_START_DATE,'YYYY-MM-DD') AS MILEST_START_DATE , TO_CHAR(A.MILEST_END_DATE,'YYYY-MM-DD') AS MILEST_END_DATE, A.MILEST_NO, SUM(A.ISSUE_STATUS)/COUNT(A.ISSUE_STATUS)*100 AS MILEST_PERCENT
		  FROM(SELECT MILESTONE.*, ISSUE.ISSUE_TITLE, ISSUE.ISSUE_STATUS
   				 FROM MILESTONE
       				 LEFT OUTER JOIN ISSUE ON(MILESTONE.MILEST_SID = ISSUE.MILEST_SID))A
		 GROUP BY A.MILEST_TITLE, A.MILEST_START_DATE, A.MILEST_END_DATE, A.MILEST_NO
	</select>
	
	
	
</mapper>