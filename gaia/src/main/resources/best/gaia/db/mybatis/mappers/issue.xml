<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="best.gaia.issue.dao.IssueDao">
	
	<resultMap type="best.gaia.vo.IssueVO" id="issueMap" autoMapping="true">
		<id property="issue_sid" column="ISSUE_SID"/>
		<collection property="assigneeList" ofType="MemberVO" javaType="java.util.Set" autoMapping="true">
			<id property="mem_no" column="MEM_NO"/>
		</collection>
		<collection property="historyList" ofType="IssueHistoryVO" javaType="java.util.List" autoMapping="true">
			<id property="issue_his_no" column="ISSUE_HIS_NO"/>
		</collection>
	</resultMap>
	
	<select id="selectIssue" parameterType="best.gaia.vo.IssueVO" resultMap="issueMap">
	SELECT A.ISSUE_SID, A.ISSUE_NO, A.LABEL_NO, LABEL.LABEL_NM
	        ,D.MEM_NO AS WRITER_NO, DM.PROJ_USER_NICK AS WRITER_NICK, D.MEM_PIC_FILE_NAME AS WRITER_PIC
	        ,A.MILEST_SID, A.PROJ_NO, A.ISSUE_TITLE
	        ,A.ISSUE_CREATE_DATE, A.ISSUE_START_DATE, A.ISSUE_END_DATE
	        ,A.ISSUE_STATUS, A.PRIORITY, A.PROGRESS
	        ,C.MEM_NO, C.MEM_ID, CM.PROJ_USER_NICK AS MEM_NICK, C.MEM_PIC_FILE_NAME
	        ,E.ISSUE_HIS_NO, E.ISSUE_SID 
	        ,F.MEM_NO AS HIS_WRITER_NO
	        ,FM.PROJ_USER_NICK AS HIS_WRITER_NICK, F.MEM_PIC_FILE_NAME AS HIS_WRITER_PIC
	        , E.ISSUE_HIS_CONT, E.ISSUE_HIS_DATE, E.ISSUE_HIS_TYPE, E.ATCH_FILE_SID
	        ,G.MILEST_TITLE
	FROM ISSUE A
	    LEFT OUTER JOIN ISSUE_ASSIGNEE B ON (A.ISSUE_SID = B.ISSUE_SID)
	    INNER JOIN MEMBER C ON (B.MEM_NO = C.MEM_NO)
	    LEFT OUTER JOIN PROJ_MEM CM ON (A.PROJ_NO = CM.PROJ_NO AND C.MEM_NO = CM.MEM_NO)
	    INNER JOIN MEMBER D ON (A.MEM_NO = D.MEM_NO)
	    LEFT OUTER JOIN PROJ_MEM DM ON (A.PROJ_NO = DM.PROJ_NO AND D.MEM_NO = DM.MEM_NO)
	    LEFT OUTER JOIN ISSUE_HISTORY E ON (A.ISSUE_SID = E.ISSUE_SID)
	    LEFT OUTER JOIN MEMBER F ON (E.MEM_NO = F.MEM_NO)
	    LEFT OUTER JOIN PROJ_MEM FM ON (A.PROJ_NO = FM.PROJ_NO AND F.MEM_NO = FM.MEM_NO)
	    LEFT OUTER JOIN MILESTONE G ON (A.MILEST_SID = G.MILEST_SID)
	    LEFT OUTER JOIN LABEL ON (A.PROJ_NO = LABEL.PROJ_NO AND A.LABEL_NO = LABEL.LABEL_NO)
	    INNER JOIN PROJECT ON (A.PROJ_NO = PROJECT.PROJ_NO)
	    INNER JOIN MEMBER PM ON (PROJECT.MEM_NO = PM.MEM_NO)
	where a.issue_no = #{issue_no}
	        and pm.mem_nick = #{mem_nick}
	        and project.proj_title = #{proj_title}
	</select>
	
	<select id="selectIssueList" parameterType="best.gaia.vo.PagingVO" resultType="best.gaia.vo.IssueVO">
		SELECT *
		FROM ISSUE
	</select>
	
	
	<select id="selectMilestoneList" parameterType="best.gaia.vo.PagingVO" resultType="best.gaia.vo.MilestoneVO">
		SELECT A.MILEST_TITLE, TO_CHAR(A.MILEST_START_DATE,'YYYY-MM-DD') AS MILEST_START_DATE , TO_CHAR(A.MILEST_END_DATE,'YYYY-MM-DD') AS MILEST_END_DATE, A.MILEST_NO, SUM(A.ISSUE_STATUS)/COUNT(A.ISSUE_STATUS)*100 AS MILEST_PERCENT
		  FROM(SELECT MILESTONE.*, ISSUE.ISSUE_TITLE, ISSUE.ISSUE_STATUS
   				 FROM MILESTONE
       				 LEFT OUTER JOIN ISSUE ON(MILESTONE.MILEST_SID = ISSUE.MILEST_SID))A
		 GROUP BY A.MILEST_TITLE, A.MILEST_START_DATE, A.MILEST_END_DATE, A.MILEST_NO
	</select>
	
	
	
</mapper>