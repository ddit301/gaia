<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="best.gaia.issue.dao.IssueDao">
	
	<resultMap type="best.gaia.vo.IssueVO" id="issueMap" autoMapping="true">
		<id property="issue_sid" column="ISSUE_ID"/>
		<collection property="assigneeList" ofType="MemberVO" javaType="java.util.Set" autoMapping="true">
			<id property="mem_no" column="MEM_NO"/>
		</collection>
		<collection property="historyList" ofType="IssueHistoryVO" javaType="java.util.List" autoMapping="true">
			<id property="issue_his_no" column="ISSUE_HIS_NO"/>
		</collection>
	</resultMap>
	
	<select id="selectIssue" parameterType="java.util.Map" resultMap="issueMap">
SELECT ISSUE.ISSUE_SID as ISSUE_ID, ISSUE_NO, ISSUE_TITLE, PROGRESS, ISSUE_STATUS, ISSUE_PRIORITY
        ,ISSUE_CREATE_DATE, ISSUE_START_DATE, ISSUE_END_DATE
        ,MILESTONE.MILEST_SID, MILESTONE.MILEST_TITLE
        ,LABEL.LABEL_NO, LABEL.LABEL_NM
        ,ISSUE.PROJ_NO
        ,WRITER.MEM_NO AS WRITER_NO, WRITER.MEM_PIC_FILE_NAME AS WRITER_PIC
        ,WRITER_PM.PROJ_USER_NICK AS WRITER_NICK
        ,ASSIGNEE.MEM_NO, ASSIGNEE.MEM_ID, ASSIGNEE.MEM_PIC_FILE_NAME, ASSIGNEE_PM.PROJ_USER_NICK AS MEM_NICK
        ,ISSUE_HISTORY.ISSUE_HIS_NO, ISSUE_HISTORY.ISSUE_HIS_CONT, ISSUE_HISTORY.ISSUE_HIS_DATE
        ,ISSUE_HISTORY.ISSUE_HIS_TYPE, ISSUE_HISTORY.ATCH_FILE_SID
        ,HIS_WRITER.MEM_NO AS HIS_WRITER_NO, HIS_WRITER.MEM_PIC_FILE_NAME AS HIS_WRITER_PIC
        ,HIS_WRITER_PM.PROJ_USER_NICK AS HIS_WRITER_NICK
FROM ISSUE
    LEFT OUTER JOIN MILESTONE ON (ISSUE.MILEST_SID = MILESTONE.MILEST_SID)
    LEFT OUTER JOIN LABEL ON (ISSUE.PROJ_NO = LABEL.PROJ_NO AND ISSUE.LABEL_NO = LABEL.LABEL_NO)
    INNER JOIN MEMBER WRITER ON (ISSUE.MEM_NO = WRITER.MEM_NO)
    LEFT OUTER JOIN PROJ_MEM WRITER_PM ON (ISSUE.PROJ_NO = WRITER_PM.PROJ_NO AND WRITER.MEM_NO = WRITER_PM.MEM_NO)
    LEFT OUTER JOIN ISSUE_ASSIGNEE IS_ASSIGNEE ON (ISSUE.ISSUE_SID = IS_ASSIGNEE.ISSUE_SID)
    LEFT OUTER JOIN MEMBER ASSIGNEE ON (IS_ASSIGNEE.MEM_NO = ASSIGNEE.MEM_NO)
    LEFT OUTER JOIN PROJ_MEM ASSIGNEE_PM ON (ISSUE.PROJ_NO = ASSIGNEE_PM.PROJ_NO AND ASSIGNEE.MEM_NO = ASSIGNEE_PM.MEM_NO)
    LEFT OUTER JOIN ISSUE_HISTORY ON (ISSUE.ISSUE_SID = ISSUE_HISTORY.ISSUE_SID)
    LEFT OUTER JOIN MEMBER HIS_WRITER ON (ISSUE_HISTORY.MEM_NO = HIS_WRITER.MEM_NO)
    LEFT OUTER JOIN PROJ_MEM HIS_WRITER_PM ON (ISSUE.PROJ_NO = HIS_WRITER_PM.PROJ_NO AND HIS_WRITER.MEM_NO = HIS_WRITER_PM.MEM_NO)
	where issue.issue_no = #{issue_no}
	        and issue.proj_no = #{proj_no}
	</select>
	
	<select id="selectIssueList" parameterType="best.gaia.vo.PagingVO" resultType="best.gaia.vo.IssueVO">
		SELECT *
		FROM ISSUE
		WHERE proj_no = #{detailSearch.proj_no}
	</select>
	
</mapper>